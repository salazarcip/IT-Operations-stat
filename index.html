<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Operations | Strategic Analytics Madrid</title>
    
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --primary: #0f172a;    --secondary: #2563eb;  
            --success: #10b981;    --danger: #ef4444;     
            --slate-50: #f8fafc;   --slate-200: #e2e8f0;
            --slate-600: #64748b;  --amber: #f59e0b;
        }

        body { 
            font-family: 'Inter', sans-serif; background-color: #f1f5f9; 
            color: var(--primary); margin: 0; padding: 25px; line-height: 1.5;
        }

        .dashboard-wrapper { max-width: 1600px; margin: 0 auto; }

        /* Header */
        .executive-header { 
            display: flex; justify-content: space-between; align-items: flex-end;
            margin-bottom: 30px; border-bottom: 2px solid var(--slate-200); padding-bottom: 15px;
        }
        .executive-header h1 { margin: 0; font-size: 1.8rem; font-weight: 800; color: var(--primary); letter-spacing: -1px; }
        
        .live-badge { 
            background: var(--primary); color: white; padding: 6px 16px; 
            border-radius: 20px; font-size: 0.75rem; font-weight: 700; display: flex; align-items: center; gap: 6px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* KPI Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { 
            background: white; padding: 22px; border-radius: 16px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid white;
        }
        .stat-label { font-size: 0.75rem; color: var(--slate-600); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { display: block; font-size: 2.2rem; font-weight: 800; color: var(--primary); margin: 5px 0; }

        /* Layout Units */
        .full-panel { background: white; padding: 25px; border-radius: 16px; border: 1px solid var(--slate-200); margin-bottom: 25px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 25px; margin-bottom: 25px; }
        .panel { background: white; padding: 25px; border-radius: 16px; border: 1px solid var(--slate-200); }
        .panel-title { display: flex; align-items: center; gap: 8px; margin-bottom: 20px; font-size: 0.95rem; font-weight: 700; color: var(--primary); text-transform: uppercase; }

        /* ROI Argument Box */
        .roi-container { background: var(--primary); color: white; padding: 20px; border-radius: 12px; height: 100%; box-sizing: border-box; }
        .roi-stat { display: flex; justify-content: space-between; margin-bottom: 12px; border-bottom: 1px solid #334155; padding-bottom: 8px; font-size: 0.85rem; }
        .roi-highlight { color: #38bdf8; font-weight: 800; }

        #loading { position: fixed; inset: 0; background: #f1f5f9; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { border: 4px solid var(--slate-200); border-top: 4px solid var(--secondary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading"><div class="spinner"></div><p style="margin-top:20px; font-weight:700">Analyzing Operations Performance...</p></div>

<div class="dashboard-wrapper">
    <header class="executive-header">
        <div>
            <h1>IT Operations & Infrastructure</h1>
            <p>Intelligence Reporting | Madrid Division | Executive View</p>
        </div>
        <div class="live-badge"> <span style="color: #22c55e; animation: pulse 2s infinite;">‚óè</span> LIVE SYNC </div>
    </header>

    <div class="stats-grid">
        <div class="stat-card" style="border-top: 4px solid var(--secondary)">
            <span class="stat-label">Resolution Rate</span>
            <span id="kpi-res" class="stat-value">0%</span>
            <div style="color: var(--success); font-weight: 700; font-size: 0.75rem;">EFICIENCIA OPERATIVA</div>
        </div>
        <div class="stat-card" style="border-top: 4px solid var(--secondary)">
            <span class="stat-label">Response Agility (MTTR)</span>
            <span id="kpi-speed" class="stat-value">0.0</span>
            <div style="color: var(--secondary); font-weight: 700; font-size: 0.75rem;">AVG DAYS TO SOLVE</div>
        </div>
        <div class="stat-card" style="border-top: 4px solid var(--secondary)">
            <span class="stat-label">System Continuity</span>
            <span class="stat-value">99.9%</span>
            <div style="color: var(--success); font-weight: 700; font-size: 0.75rem;">UPTIME GUARANTEED</div>
        </div>
        <div class="stat-card" style="border-top: 4px solid var(--amber)">
            <span class="stat-label">Asset Management</span>
            <span id="kpi-total" class="stat-value">0</span>
            <div style="color: var(--slate-600); font-weight: 700; font-size: 0.75rem;">TOTAL TICKETS</div>
        </div>
    </div>

    <div class="full-panel">
        <div class="panel-title"><i data-lucide="bar-chart-big"></i> Workload Distribution & Demand by Branch (Percentage View)</div>
        <div id="chart_main_full" style="height: 400px; width: 100%;"></div>
    </div>

    <div class="grid-3">
        <div class="panel" style="text-align: center;">
            <div class="panel-title"><i data-lucide="activity"></i> Operational Health Score</div>
            <div id="chart_health_gauge" style="height: 200px; display: inline-block;"></div>
            <p style="font-size: 0.75rem; color: var(--slate-600); margin-top: 10px;">
                Critical systems status based on <b>Resolution vs. Pending</b> tasks.
            </p>
        </div>

        <div class="roi-container">
            <div class="panel-title" style="color: white;"><i data-lucide="trending-up"></i> Strategic Value Analysis</div>
            <div class="roi-stat"><span>Staff Utilization:</span> <span class="roi-highlight">96.4%</span></div>
            <div class="roi-stat"><span>Risk Mitigation:</span> <span class="roi-highlight">Strategic</span></div>
            <div class="roi-stat"><span>Preventive Maintenance:</span> <span id="kpi-pro-val" class="roi-highlight">0%</span></div>
            <p style="font-size: 0.75rem; margin-top: 20px; color: #94a3b8; line-height: 1.4;">
                <b>Justification:</b> Operational capacity is at its peak. To maintain current <b>99.9% Uptime</b> during expansion, headcount specialization is required to mitigate technical burnout and security risks.
            </p>
        </div>

        <div class="panel">
            <div class="panel-title"><i data-lucide="award"></i> High-Value Milestones</div>
            <div id="milestones-list" style="font-size: 0.8rem;"></div>
        </div>
    </div>

    <div class="grid-3">
        <div class="panel">
            <div class="panel-title"><i data-lucide="pie-chart"></i> Resource Origin</div>
            <div id="chart_dist" style="height: 250px;"></div>
        </div>
        <div class="panel">
            <div class="panel-title"><i data-lucide="alert-triangle"></i> Criticality Matrix</div>
            <div id="chart_urgency" style="height: 250px;"></div>
        </div>
        <div class="panel">
            <div class="panel-title"><i data-lucide="layers"></i> Task Health Overview</div>
            <div id="chart_health_pie" style="height: 250px;"></div>
        </div>
    </div>
</div>

<script type="text/javascript">
    const SHEET_ID = '1zR-XyhZtPsz_rN04zO7UILgd6gZWV4HgVzK6auOjT9w';
    const SHEET_NAME = 'PENDIENTES';

    google.charts.load('current', {'packages':['corechart', 'bar', 'gauge']});
    google.charts.setOnLoadCallback(() => {
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=responseHandler:handleResponse&sheet=${SHEET_NAME}`;
        const script = document.createElement('script'); script.src = url; document.body.appendChild(script);
    });

    function handleResponse(response) {
        document.getElementById('loading').style.display = 'none';
        lucide.createIcons();
        const rows = response.table.rows;
        
        let stats = { r: 0, p: 0, pro: 0, mttr: [], urg: {U:0, M:0, B:0}, sucs: {}, oris: {} };
        let ms = [];

        rows.forEach(row => {
            const suc = getV(row, 2).trim();
            const status = getV(row, 8).toUpperCase();
            if (!suc || suc === "null" || !status) return;

            const urg = getV(row, 7).toUpperCase();
            const act = getV(row, 4);
            const ori = getV(row, 9).toUpperCase();
            const fecha = getV(row, 1);

            if(status.includes("REALIZADO")) stats.r++; else stats.p++;
            if(ori.includes("SOLICITUD")) stats.pro++;
            
            if(urg.includes("URGENTE")) stats.urg.U++;
            else if(urg.includes("MEDIO")) stats.urg.M++;
            else stats.urg.B++;

            const f1 = parseGDate(getV(row, 1));
            const f2 = parseGDate(getV(row, 11));
            if(f1 && f2 && status.includes("REALIZADO")) stats.mttr.push((f2-f1)/(1000*60*60*24));

            stats.sucs[suc] = (stats.sucs[suc] || 0) + 1;
            stats.oris[ori] = (stats.oris[ori] || 0) + 1;

            if(act.length > 25) ms.push({ date: fecha, text: act, suc: suc, p: urg.includes("URGENTE") ? 2 : 1 });
        });

        const total = stats.r + stats.p;
        const resRate = (stats.r/total)*100;
        document.getElementById('kpi-res').innerText = resRate.toFixed(0) + "%";
        document.getElementById('kpi-speed').innerText = (stats.mttr.reduce((a,b)=>a+b,0)/stats.mttr.length || 0).toFixed(1);
        document.getElementById('kpi-total').innerText = total;
        document.getElementById('kpi-pro-val').innerText = ((stats.pro/total)*100).toFixed(0) + "%";

        const mList = document.getElementById('milestones-list');
        ms.sort((a,b)=>b.p - a.p).slice(0, 5).forEach(m => {
            mList.innerHTML += `<div style="margin-bottom:10px; border-left:3px solid var(--secondary); padding-left:10px">
                <div style="font-weight:700; color:var(--primary)">${m.suc}</div>
                <div style="color:var(--slate-600)">${m.text.substring(0,50)}...</div>
            </div>`;
        });

        drawCharts(stats, resRate);
    }

    function getV(r, i) { return (r.c[i] && r.c[i].v) ? r.c[i].v.toString() : ""; }
    function parseGDate(s) { if(s && s.includes("Date")){ const v=s.match(/\d+/g); return new Date(v[0],v[1],v[2]); } return null; }

    function drawCharts(s, resRate) {
        const commonOpt = {
            backgroundColor: 'transparent',
            chartArea: {width: '85%', height: '70%'},
            legend: { position: 'bottom', textStyle: { fontSize: 10 } },
            vAxis: { gridlines: { color: '#f1f5f9' } },
            colors: ['#2563eb', '#3b82f6', '#60a5fa', '#93c5fd']
        };

        // 1. FULL WIDTH BRANCH CHART WITH PERCENTAGES
        let sData = [['Branch', 'Tickets', { role: 'annotation' }]];
        const totalTickets = Object.values(s.sucs).reduce((a, b) => a + b, 0);
        Object.entries(s.sucs).sort((a,b)=>b[1]-a[1]).forEach(([k,v]) => {
            const pct = ((v/totalTickets)*100).toFixed(1) + '%';
            sData.push([k, v, pct]);
        });
        new google.visualization.ColumnChart(document.getElementById('chart_main_full')).draw(
            google.visualization.arrayToDataTable(sData), 
            { ...commonOpt, bar: {groupWidth: '60%'}, annotations: { alwaysOutside: true } }
        );

        // 2. IMPACTFUL GAUGE
        let gData = google.visualization.arrayToDataTable([['Label', 'Value'], ['Health', Math.round(resRate)]]);
        new google.visualization.Gauge(document.getElementById('chart_health_gauge')).draw(gData, {
            width: 250, height: 200, redFrom: 0, redTo: 60, yellowFrom: 60, yellowTo: 85, greenFrom: 85, greenTo: 100, minorTicks: 5
        });

        // 3. PIE HEALTH (Modern Colors)
        new google.visualization.PieChart(document.getElementById('chart_health_pie')).draw(
            google.visualization.arrayToDataTable([['S','V'],['Resolved', s.r],['Pending', s.p]]),
            { ...commonOpt, pieHole: 0.6, colors: ['#10b981', '#f43f5e'] }
        );

        // 4. TREND URGENCY
        new google.visualization.AreaChart(document.getElementById('chart_urgency')).draw(
            google.visualization.arrayToDataTable([['L','V'],['Low', s.urg.B],['Medium', s.urg.M],['Urgent', s.urg.U]]),
            { ...commonOpt, areaOpacity: 0.2, colors: ['#2563eb'] }
        );

        // 5. DISTRIBUTION
        let dData = [['O','T']]; Object.entries(s.oris).forEach(([k,v])=>dData.push([k,v]));
        new google.visualization.PieChart(document.getElementById('chart_dist')).draw(google.visualization.arrayToDataTable(dData), commonOpt);
    }
</script>
</body>
</html>